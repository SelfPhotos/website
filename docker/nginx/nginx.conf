# 运行 Nginx 的用户，通常是 nginx 或 www-data
user  nginx;

# 自动检测 CPU 核心数，最佳实践
worker_processes  auto;

# 错误日志级别，从 notice 改为 warn，减少日志噪音，生产环境推荐
error_log  /var/log/nginx/error.log warn;
pid        /run/nginx.pid;

# 事件驱动模块配置
events {
    # 每个工作进程可以处理的最大连接数，可以设置得更高
    worker_connections  4096;

    # 尽可能多地接受连接，防止惊群问题
    multi_accept on;
}

# HTTP 核心模块配置
http {
    # 包含 MIME 类型定义
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # 隐藏 Nginx 版本号，提高安全性
    server_tokens off;

    # --- 日志格式定义 ---
    # 简化并优化日志格式，移除了不必要的 $http_x_forwarded_for (如果不用CDN的话)
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent"';

    access_log  /var/log/nginx/access.log  main;

    # --- 核心性能优化 ---
    sendfile        on;            # 高效文件传输
    tcp_nopush      on;            # 配合 sendfile，在发送响应头之后一次性发送整个文件包，减少网络包数量
    tcp_nodelay     on;            # 禁用 Nagle 算法，减少延迟，对小文件和实时通信有好处
    keepalive_timeout  65;         # 保持连接时间
    keepalive_requests 10000;       # 单个长连接可以处理的最大请求数

    # 静态文件关键优化：启用文件缓存
    # 缓存 10000 个文件，最大缓存时间 60 秒
    open_file_cache max=10000 inactive=60s;
    open_file_cache_valid 80s;
    open_file_cache_min_uses 1;
    open_file_cache_errors on;

    # --- Gzip 压缩 ---
    gzip on;                       # 开启 Gzip 压缩
    gzip_vary on;                  # 在响应头中添加 Vary: Accept-Encoding
    gzip_proxied any;              # 对所有代理请求的响应进行压缩
    gzip_comp_level 6;             # 压缩级别 (1-9)，6是性能和压缩率的良好平衡点
    gzip_buffers 16 8k;            # Nginx 将为 Gzip 压缩操作分配 $16 * 8KB = 128KB 的内存空间（每个 worker 进程）
    gzip_min_length 1000;          # 小于 1000 字节的文件不压缩，避免浪费 CPU
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/xml+rss
        application/json
        image/svg+xml;          # 指定需要压缩的文件类型

    # --- 安全相关头部 (通过 add_header 添加) ---
    # 这些将在 server 块中配置，因为它们通常只对特定站点生效

    # --- 包含其他配置文件 ---
    include /etc/nginx/conf.d/*.conf;
}
